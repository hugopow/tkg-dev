# Add new cluster context
tanzu cluster kubeconfig get tkg-k8slabs --admin

# Clean up Terminating namespace
kubectl get namespace kubeapps -o json \
  | tr -d "\n" | sed "s/\"finalizers\": \[[^]]\+\]/\"finalizers\": []/" \
  | kubectl replace --raw /api/v1/namespaces/kubeapps/finalize -f -

# Add a Package Repository
tanzu package repository add tanzu-standard --url projects.registry.vmware.com/tkg/packages/standard/repo:v2024.4.12 --namespace tkg-system

# List Available Packages
tanzu package available list -A

# Retrieve the version of the available package
tanzu package available list cert-manager.tanzu.vmware.com -A

# Create my-packages namespace
k create ns my-packages

# Install the cert-manager package
tanzu package install cert-manager --package cert-manager.tanzu.vmware.com --namespace my-packages --version 1.12.2+vmware.2-tkg.2


# Retrieve the version of the available package
tanzu package available list contour.tanzu.vmware.com -A

# Install Contour

tanzu package install contour \
--package contour.tanzu.vmware.com \
--version 1.28.2+vmware.1-tkg.1 \
--values-file contour-data-values.yaml \
--namespace my-packages

tanzu package available list harbor.tanzu.vmware.com -A

# Install Harbor

tanzu package install harbor \
--package harbor.tanzu.vmware.com \
--version 2.9.1+vmware.1-tkg.1 \
--values-file harbor-data-values.yaml \
--namespace my-packages

# Install KubeApps
kubectl create namespace kubeapps
helm install kubeapps --namespace kubeapps oci://registry-1.docker.io/bitnamicharts/kubeapps

kubectl create --namespace default serviceaccount kubeapps-operator
kubectl create clusterrolebinding kubeapps-operator --clusterrole=cluster-admin --serviceaccount=default:kubeapps-operator
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: kubeapps-operator-token
  namespace: default
  annotations:
    kubernetes.io/service-account.name: kubeapps-operator
type: kubernetes.io/service-account-token
EOF

# Enable KubeApps contour
k apply -f kubeapps-contour.yaml

# Obtain KubeApps token
kubectl get --namespace default secret kubeapps-operator-token -o go-template='{{.data.token | base64decode}}'

# Deploy PostgreSQL in KubeApps
15.4.0-debian-11-r56

20Gi

# Expose using load balancer service
k expose pod -n vmware-cloud-director postgresql-0 --type=LoadBalancer --name postgresql-public

# Backup vcloud database
pg_dump  -h 172.16.4.69 -U postgres vcloud > /backups/11-11-2024-database-a.sql

# Restore vcloud database
psql -U postgres -p 5432 -h 172.16.4.69 -d vcloud < /backups/08-11-2024-database-b.sql


# Deploy VCD
helm install vmware-cloud-director vmware-cloud-director --version 10.6.0 -n vmware-cloud-director -f /home/phanh/vmware-cloud-director/values.yaml

# Deploy App Launchpad
helm install app-launchpad app-launchpad --version 0.7.0 -n app-launchpad -f /home/phanh/app-launchpad/values.yaml

# Marketplace token
7k14NiHV0NhzLblYu-SlhB9T-s2A1nFz06FdQXhu-yLe_zMZDn72AqBpOpOIC0BK


# Clean up Terminating namespace
kubectl get namespace cattle-fleet-local-system -o json \
  | tr -d "\n" | sed "s/\"finalizers\": \[[^]]\+\]/\"finalizers\": []/" \
  | kubectl replace --raw /api/v1/namespaces/cattle-fleet-local-system/finalize -f -


helm pull  rancher-stable/rancher


